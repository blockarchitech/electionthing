<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Globe</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.87/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.87/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        #cesiumContainer {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <script>
        // Initialize the Cesium Viewer in the HTML element with the id `cesiumContainer`
        const viewer = new Cesium.Viewer('cesiumContainer');

        // Fetch election data from the GraphQL API
        async function fetchElectionData() {
            const response = await fetch('/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: `
                        query {
                            states {
                                state
                                results {
                                    party
                                    percentage
                                }
                            }
                        }
                    `
                })
            });
            const result = await response.json();
            return result.data.states;
        }

        // Fetch state boundaries from OpenStreetMap/Overpass
        async function fetchStateBoundaries() {
            const response = await fetch('https://overpass-api.de/api/interpreter?data=[out:json];relation["admin_level"="4"]["boundary"="administrative"]["type"="boundary"]["admin_level"="4"]["ISO3166-2"~"^US-"];out geom;');
            const data = await response.json();
            return data.elements;
        }

        // Render the globe and shade states based on party affiliation
        async function renderGlobe() {
            const electionData = await fetchElectionData();
            const stateBoundaries = await fetchStateBoundaries();

            stateBoundaries.forEach(state => {
                const stateData = electionData.find(s => s.state === state.tags['ISO3166-2'].split('-')[1]);
                if (stateData) {
                    const demPercentage = stateData.results.filter(result => result.party === 'DEM').reduce((acc, result) => acc + result.percentage, 0);
                    const repPercentage = stateData.results.filter(result => result.party === 'REP').reduce((acc, result) => acc + result.percentage, 0);
                    let color;
                    if (demPercentage > repPercentage) {
                        color = Cesium.Color.BLUE.withAlpha(demPercentage / 100);
                    } else {
                        color = Cesium.Color.RED.withAlpha(repPercentage / 100);
                    }
                    const hierarchy = new Cesium.PolygonHierarchy(Cesium.Cartesian3.fromDegreesArray(state.geometry.map(coord => [coord.lon, coord.lat]).flat()));
                    viewer.entities.add({
                        polygon: {
                            hierarchy: hierarchy,
                            material: color
                        }
                    });
                }
            });
        }

        renderGlobe();
    </script>
</body>
</html>
